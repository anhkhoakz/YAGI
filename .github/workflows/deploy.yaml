on:
        workflow_dispatch:
        push:
                tags:
                        - "*"

name: Deploy Extension
jobs:
        deploy:
                runs-on: ubuntu-latest
                permissions:
                        contents: write
                steps:
                        - uses: actions/checkout@v5
                        - uses: oven-sh/setup-bun@v2
                          with:
                                  bun-version: latest
                        - run: bun install --frozen-lockfile
                        - name: Package VSIX
                          run: npx --yes @vscode/vsce package
                        - name: Publish to Open VSX Registry
                          uses: HaaLeo/publish-vscode-extension@v2
                          with:
                                  pat: ${{ secrets.OPEN_VSX_TOKEN }}
                        - name: Publish to Visual Studio Marketplace
                          uses: HaaLeo/publish-vscode-extension@v2
                          with:
                                  pat: ${{ secrets.VS_MARKETPLACE_TOKEN }}
                                  registryUrl: https://marketplace.visualstudio.com
                        - name: Upload VSIX Artifact
                          uses: actions/upload-artifact@v4
                          with:
                                  name: vsix
                                  path: ./*.vsix
                        - name: Create GitHub Release with VSIX
                          if: startsWith(github.ref, 'refs/tags/')
                          uses: softprops/action-gh-release@v2
                          with:
                                  files: ./*.vsix
                        - name: Upload Artifacts
                          uses: actions/upload-artifact@v4
                          with:
                                  name: extension
                                  path: dist
